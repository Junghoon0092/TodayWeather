angular.module("controller.purchase",[]).factory("Purchase",["$rootScope","$http","$q","TwAds","Util",function(e,t,o,n,i){var r={};return r.ACCOUNT_LEVEL_FREE="free",r.ACCOUNT_LEVEL_PREMIUM="premium",r.accountLevel,r.productId,r.expirationDate,r.loaded=!1,r.products,r.setAccountLevel=function(e){r.accountLevel!=e&&(r.accountLevel=e,e===r.ACCOUNT_LEVEL_FREE?n.setEnableAds(!0):e===r.ACCOUNT_LEVEL_PREMIUM&&n.setEnableAds(!1))},r.checkReceiptValidation=function(e,o){var n=i.url+"/check-purchase";t({method:"POST",headers:{"Content-Type":"application/json"},url:n,data:e,timeout:1e4}).then(function(e){o(void 0,e.data)},function(e){o(e)})},r.saveStoreReceipt=function(e){localStorage.setItem("storeReceipt",JSON.stringify(e))},r.loadStoreReceipt=function(){return JSON.parse(localStorage.getItem("storeReceipt"))},r.loadPurchaseInfo=function(){var e=JSON.parse(localStorage.getItem("purchaseInfo"));void 0!=e?(r.expirationDate=e.expirationDate,new Date(e.expirationDate).getTime()<Date.now()&&(e.accountLevel=r.ACCOUNT_LEVEL_FREE),r.setAccountLevel(e.accountLevel)):r.accountLevel=r.ACCOUNT_LEVEL_FREE},r.savePurchaseInfo=function(e,t){var o={accountLevel:e,expirationDate:t};localStorage.setItem("purchaseInfo",JSON.stringify(o)),n.saveTwAdsInfo(o.accountLevel===r.ACCOUNT_LEVEL_PREMIUM?!1:!0)},r.updatePurchaseInfo=function(){var e=function(){if(ionic.Platform.isIOS())return inAppPurchase.getReceipt().then(function(e){return void 0==e?void 0:{type:"ios",id:r.productId,receipt:e}});if(ionic.Platform.isAndroid())return inAppPurchase.restorePurchases().then(function(e){return e.forEach(function(e){JSON.parse(e.receipt)}),0==e.length?void 0:{type:"android",id:r.productId,receipt:e}});throw new Error("Unknown platform")};return e().then(function(e){if(void 0==e)throw new Error("Can not find any purchase");r.saveStoreReceipt(e);var t=o.defer();return r.checkReceiptValidation(e,function(e,o){return e?void t.reject(new Error("Fail to connect validation server. Please restore after 1~2 minutes")):void t.resolve(o)}),t.promise})},r}]).run(["$ionicPlatform","$ionicPopup","$q","Purchase",function(e,t,o,n){function i(){var e,t;e=n.loadStoreReceipt(),t=e?function(){var t=o.defer();return n.checkReceiptValidation(e,function(e,o){return e?void t.reject(new Error("Fail to connect validation server. Please restore after 1~2 minutes")):void t.resolve(o)}),t.promise}:n.updatePurchaseInfo,t().then(function(e){n.loaded=!0,e.ok||(n.setAccountLevel(n.ACCOUNT_LEVEL_FREE),n.savePurchaseInfo(n.accountLevel,n.expirationDate))}).catch(function(e){})}n.loadPurchaseInfo(),e.ready(function(){return!n.loaded&&(n.productId="tw1year",window.inAppPurchase)?(inAppPurchase.getProducts([n.productId]).then(function(e){n.products=e,n.loaded===!1&&i()}).catch(function(e){}),n.accountLevel===n.ACCOUNT_LEVEL_FREE?void(n.loaded=!0):void i()):void 0})}]).controller("PurchaseCtrl",["$scope","$ionicPlatform","$ionicLoading","$http","$ionicHistory","$ionicPopup","Purchase","TwAds",function(e,t,o,n,i,r,a,c){var u='<ion-spinner icon="dots" class="spinner-stable"></ion-spinner><br/>';e.order=function(){o.show({template:u+"Purchasing..."}),inAppPurchase.subscribe(a.productId).then(function(e){return ionic.Platform.isIOS()?{type:"ios",id:a.productId,receipt:e.receipt}:ionic.Platform.isAndroid()?{type:"android",id:a.productId,receipt:[e]}:void 0}).then(function(t){a.saveStoreReceipt(t),a.checkReceiptValidation(t,function(t,n){if(o.hide(),t)throw new Error("구매확인 서버에 연결되지 않습니다. 1~2분후에 구매 복원하기 해주세요.");if(!n.ok)throw new Error(n.data.message);a.setAccountLevel(a.ACCOUNT_LEVEL_PREMIUM),a.expirationDate=n.data.expires_date,e.accountLevel=a.ACCOUNT_LEVEL_PREMIUM,e.expirationDate=new Date(a.expirationDate).toLocaleDateString(),a.savePurchaseInfo(a.accountLevel,a.expirationDate)})}).catch(function(e){o.hide(),r.alert({title:"구매 오류",template:e.message})})},e.restore=function(){o.show({template:u+"Restoring Purchases..."}),a.updatePurchaseInfo().then(function(t){if(o.hide(),!t.ok)throw new Error(t.data.message);a.setAccountLevel(a.ACCOUNT_LEVEL_PREMIUM),a.expirationDate=t.data.expires_date,e.accountLevel=a.ACCOUNT_LEVEL_PREMIUM,e.expirationDate=new Date(a.expirationDate).toLocaleDateString(),a.savePurchaseInfo(a.accountLevel,a.expirationDate)}).catch(function(e){o.hide(),r.alert({title:"복원오류",template:e.message})})},e.goBack=function(){c.setShowAds(!0),i.goBack()},e.$on("$ionicView.leave",function(){c.setShowAds(!0)}),e.$on("$ionicView.enter",function(){c.setShowAds(!1),window.StatusBar&&StatusBar.backgroundColorByHexString("#0288D1")}),t.ready(function(){c.setShowAds(!1),e.accountLevel=a.accountLevel,e.expirationDate=new Date(a.expirationDate).toLocaleDateString(),e.showRenew=!1,window.inAppPurchase?a.products&&a.products.length&&(e.product=a.products[0]):e.product={title:"프리미엄",price:"$1.09",description:"지금 바로 프리미엄 서비스를 신청하시고, 1년간 광고 없이 사용하세요."},e.listWidth=window.innerWidth})}]);