angular.module("service.push",[]).factory("Push",["$http","Util","WeatherUtil","WeatherInfo","$location",function(t,a,i,n,e){function r(a){var i=a.time,n=60*i.getUTCHours()*60+60*i.getUTCMinutes(),e={registrationId:u.pushData.registrationId,type:u.pushData.type,pushTime:n,cityIndex:a.cityIndex,town:a.town};t({method:"POST",headers:{"Content-Type":"application/json"},url:u.pushUrl,data:e,timeout:1e4}).then(function(t){},function(t){})}function s(a){var i={registrationId:u.pushData.registrationId,type:u.pushData.type,cityIndex:a.cityIndex,town:a.town};t({method:"DELETE",headers:{"Content-Type":"application/json"},url:u.pushUrl,data:i,timeout:1e4}).then(function(t){},function(t){})}function o(a){t({method:"PUT",headers:{"Content-Type":"application/json"},url:u.pushUrl,data:{newRegId:a,oldRegId:u.pushData.registrationId},timeout:1e4}).then(function(t){},function(t){}),u.pushData.registrationId=a}var u={};return u.config={android:{senderID:a.googleSenderId},ios:{alert:"true",badge:"true",sound:"true",clearBadge:"true"},windows:{}},u.pushUrl=a.url+"/push",u.pushData={registrationId:"",type:"",alarmList:[]},u.loadPushInfo=function(){var t=this,a=JSON.parse(localStorage.getItem("pushData"));null!=a&&(t.pushData.registrationId=a.registrationId,t.pushData.type=a.type,t.pushData.alarmList=a.alarmList,t.pushData.alarmList.forEach(function(t){t.time=new Date(t.time)}),t.pushData.alarmList.length>0&&setTimeout(function(){t.pushData.alarmList.forEach(function(t){r(t)})},3e3))},u.savePushInfo=function(){var t=this;localStorage.setItem("pushData",JSON.stringify(t.pushData))},u.register=function(t){var a=this;window.PushNotification&&(window.push=PushNotification.init(a.config),window.push.on("registration",function(i){return a.pushData.registrationId!=i.registrationId&&o(i.registrationId),t(i.registrationId)}),window.push.on("notification",function(t){if(t.additionalData.foreground===!1){var a="/tab/forecast?fav="+t.additionalData.cityIndex;n.setCityIndex(t.additionalData.cityIndex),e.url(a)}}),window.push.on("error",function(t){}),window.push.updateAlarm=function(t,a,i,n){return u.updateAlarm(t,a,i,n)},window.push.getAlarm=function(t){return u.getAlarm(t)})},u.unregister=function(){},u.updateAlarm=function(t,a,n,e){var s=i.getTownFromFullAddress(i.convertAddressArray(a)),o={cityIndex:t,town:s,time:n},u=this;if(e||(e=function(t){}),0==u.pushData.alarmList.length)u.pushData.alarmList.push(o);else{for(var h=0;h<u.pushData.alarmList.length;h++){var d=u.pushData.alarmList[h];if(d.cityIndex===o.cityIndex)break}if(h<u.pushData.alarmList.length){if(n||(o.time=u.pushData.alarmList[h].time),o.time.getTime()==u.pushData.alarmList[h].time.getTime()&&JSON.stringify(o.town)==JSON.stringify(u.pushData.alarmList[h].town))return e(void 0,o);u.pushData.alarmList[h]=o}else{if(!n){var l=new Error("You have to set time for add alarm");return e(l)}u.pushData.alarmList.push(o)}}return window.push?(r(o),u.savePushInfo(),e(void 0,o)):void u.register(function(){return r(o),u.savePushInfo(),e(void 0,o)})},u.removeAlarm=function(t){for(var a=this,i=0;i<a.pushData.alarmList.length;i++){var n=a.pushData.alarmList[i];if(n.cityIndex===t.cityIndex)break}i!=a.pushData.alarmList.length&&(a.pushData.alarmList.splice(i,1),s(t),0==a.pushData.alarmList.length&&a.unregister(),a.savePushInfo())},u.getAlarm=function(t){for(var a=this,i=0;i<a.pushData.alarmList.length;i++){var n=a.pushData.alarmList[i];if(n.cityIndex===t)return a.pushData.alarmList[i]}},u}]).run(["$ionicPlatform","Push",function(t,a){a.loadPushInfo(),t.ready(function(){if(window.PushNotification&&(ionic.Platform.isIOS()?a.pushData.type="ios":ionic.Platform.isAndroid()&&(a.pushData.type="android"),a.pushData.alarmList.length>0)){if(PushNotification.hasPermission(function(t){t.isEnabled}),window.push)return;a.register(function(t){})}})}]);