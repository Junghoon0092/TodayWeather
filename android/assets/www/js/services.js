angular.module("starter.services",[]).factory("WeatherInfo",["$q","$http","WeatherUtil",function(t,e,n){var i={cities:[],towns:[],cityIndex:0,loadIndex:-1};return i.addCity=function(t){var e=this;return-1===e.getIndexOfCity(t)?(e.cities.push(t),e.saveCities(),!0):!1},i.removeCity=function(t){var e=this;return-1!==t?(e.cities.splice(t,1),e.saveCities(),!0):!1},i.updateCity=function(t,e){var n=this,i=n.cities[t];e.address&&(i.address=e.address),e.location&&(i.location=e.location),e.currentWeather&&(i.currentWeather=e.currentWeather),e.timeTable&&(i.timeTable=e.timeTable),e.timeChart&&(i.timeChart=e.timeChart),e.dayTable&&(i.dayTable=e.dayTable),e.dayChart&&(i.dayChart=e.dayChart),window.push&&1==i.currentPosition&&window.push.getAlarm(t)&&window.push.updateAlarm(t,i.address),n.saveCities()},i.getIndexOfCity=function(t){for(var e=this,n=0;n<e.cities.length;n+=1)if(e.cities[n].currentPosition===!0){if(t.currentPosition===!0)return n}else if(e.cities[n].address===t.address)return n;return-1},i.getCityOfIndex=function(t){var e=this;return 0>t||t>=e.cities.length?null:e.cities[t]},i.getCityCount=function(){var t=this;return t.cities.length},i.loadCities=function(){if("undefined"==typeof Storage)return!1;var t=this;if(t.cities=JSON.parse(localStorage.getItem("cities")),null===t.cities){var e={};e.currentPosition=!0,e.address="대한민국 하늘시 중구 구름동",e.location=null,e.currentWeather={time:7,t1h:19,skyIcon:"SunBigCloud",tmn:14,tmx:28,summary:"어제보다 1도 낮음,미세먼지보통"};var n=[];n[0]={day:"",time:6,timeStr:"6시",t3h:17,skyIcon:"Cloud",pop:10,tempIcon:"Temp-01",tmn:17,tmx:-50},n[1]={day:"",time:9,timeStr:"9시",t3h:21,skyIcon:"CloudLightning",pop:20,tempIcon:"Temp-02",tmn:-50,tmx:-50},n[2]={day:"",time:12,timeStr:"12시",t3h:26,skyIcon:"Moon",pop:30,tempIcon:"Temp-03",tmn:-50,tmx:-50},n[3]={day:"",time:15,timeStr:"15시",t3h:28,skyIcon:"MoonBigCloud",pop:40,tempIcon:"Temp-04",tmn:-50,tmx:28},n[4]={day:"",time:18,timeStr:"18시",t3h:26,skyIcon:"CloudRain",pop:50,tempIcon:"Temp-05",tmn:-50,tmx:-50},n[5]={day:"",time:21,timeStr:"21시",t3h:21,skyIcon:"CloudRainLightning",pop:60,tempIcon:"Temp-06",tmn:-50,tmx:-50},n[6]={day:"어제",time:0,timeStr:"0시",t3h:18,skyIcon:"CloudRainSnow",pop:70,tempIcon:"Temp-07",tmn:-50,tmx:-50},n[7]={day:"",time:3,timeStr:"3시",t3h:16,skyIcon:"CloudSnow",pop:80,tempIcon:"Temp-08",tmn:-50,tmx:-50},n[8]={day:"",time:6,timeStr:"6시",t3h:15,skyIcon:"CloudSnowLightning",pop:90,tempIcon:"Temp-09",tmn:15,tmx:-50},n[9]={day:"",time:9,timeStr:"9시",t3h:21,skyIcon:"Sun",pop:10,tempIcon:"Temp-10",tmn:-50,tmx:-50},n[10]={day:"",time:12,timeStr:"12시",t3h:26,skyIcon:"SunBigCloud",pop:20,tempIcon:"Temp-10",tmn:-50,tmx:-50},n[11]={day:"",time:15,timeStr:"15시",t3h:28,skyIcon:"Cloud",pop:30,tempIcon:"Temp-01",tmn:-50,tmx:-50},n[12]={day:"",time:18,timeStr:"18시",t3h:29,skyIcon:"CloudRain",pop:50,tempIcon:"Temp-04",tmn:-50,tmx:29},n[13]={day:"",time:21,timeStr:"21시",t3h:21,skyIcon:"CloudRainLightning",pop:60,tempIcon:"Temp-05",tmn:-50,tmx:-50},n[14]={day:"오늘",time:0,timeStr:"0시",t3h:18,skyIcon:"CloudRainSnow",pop:70,tempIcon:"Temp-06",tmn:-50,tmx:-50},n[15]={day:"",time:3,timeStr:"3시",t3h:15,skyIcon:"CloudSnow",pop:80,tempIcon:"Temp-07",tmn:-50,tmx:-50},n[16]={day:"",time:6,timeStr:"6시",t3h:14,skyIcon:"CloudSnowLightning",pop:90,tempIcon:"Temp-08",tmn:14,tmx:-50},n[17]={day:"",time:9,timeStr:"9시",t3h:21,skyIcon:"Cloud",pop:10,tempIcon:"Temp-09",tmn:-50,tmx:-50},n[18]={day:"",time:12,timeStr:"12시",t3h:26,skyIcon:"CloudLightning",pop:20,tempIcon:"Temp-10",tmn:-50,tmx:-50},n[19]={day:"",time:15,timeStr:"15시",t3h:29,skyIcon:"Moon",pop:30,tempIcon:"Temp-01",tmn:-50,tmx:29},n[20]={day:"",time:18,timeStr:"18시",t3h:28,skyIcon:"MoonBigCloud",pop:50,tempIcon:"Temp-04",tmn:-50,tmx:-50},n[21]={day:"",time:21,timeStr:"21시",t3h:22,skyIcon:"CloudRain",pop:60,tempIcon:"Temp-05",tmn:-50,tmx:-50},n[22]={day:"내일",time:0,timeStr:"0시",t3h:20,skyIcon:"CloudRainSnow",pop:70,tempIcon:"Temp-06",tmn:-50,tmx:-50},n[23]={day:"",time:3,timeStr:"3시",t3h:18,skyIcon:"CloudRainLightning",pop:80,tempIcon:"Temp-07",tmn:-50,tmx:-50},n[24]={day:"",time:6,timeStr:"6시",t3h:17,skyIcon:"CloudSnowLightning",pop:90,tempIcon:"Temp-08",tmn:17,tmx:-50},n[25]={day:"",time:9,timeStr:"9시",t3h:21,skyIcon:"Sun",pop:10,tempIcon:"Temp-09",tmn:-50,tmx:-50},n[26]={day:"",time:12,timeStr:"12시",t3h:27,skyIcon:"SunBigCloud",pop:20,tempIcon:"Temp-10",tmn:-50,tmx:-50},n[27]={day:"",time:15,timeStr:"15시",t3h:29,skyIcon:"Cloud",pop:30,tempIcon:"Temp-01",tmn:-50,tmx:29},n[28]={day:"",time:18,timeStr:"18시",t3h:28,skyIcon:"CloudRain",pop:50,tempIcon:"Temp-04",tmn:-50,tmx:-50},n[29]={day:"",time:21,timeStr:"21시",t3h:24,skyIcon:"CloudRainLightning",pop:60,tempIcon:"Temp-05",tmn:-50,tmx:-50},n[30]={day:"모레",time:0,timeStr:"0시",t3h:21,skyIcon:"CloudRainSnow",pop:70,tempIcon:"Temp-06",tmn:-50,tmx:-50},n[31]={day:"",time:3,timeStr:"3시",t3h:18,skyIcon:"CloudSnow",pop:80,tempIcon:"Temp-07",tmn:-50,tmx:-50},e.timeTable=n.slice(8),e.timeChart=[{name:"yesterday",values:n.slice(0,n.length-8).map(function(t){return{name:"yesterday",value:t}})},{name:"today",values:n.slice(8).map(function(t){return{name:"today",value:t}})}];var i=[];i[0]={week:"목",skyIcon:"Cloud",pop:10,humidityIcon:"Humidity-10",reh:10,tmn:10,tmx:28},i[1]={week:"금",skyIcon:"CloudLightning",pop:20,humidityIcon:"Humidity-20",reh:10,tmn:17,tmx:26},i[2]={week:"토",skyIcon:"Moon",pop:30,humidityIcon:"Humidity-30",reh:10,tmn:16,tmx:23},i[3]={week:"일",skyIcon:"MoonBigCloud",pop:40,humidityIcon:"Humidity-40",reh:10,tmn:14,tmx:22},i[4]={week:"월",skyIcon:"CloudRain",pop:50,humidityIcon:"Humidity-50",reh:10,tmn:14,tmx:22},i[5]={week:"화",skyIcon:"CloudRainLightning",pop:60,humidityIcon:"Humidity-60",reh:10,tmn:12,tmx:22},i[6]={week:"수",skyIcon:"CloudRainSnow",pop:70,humidityIcon:"Humidity-70",reh:10,tmn:15,tmx:27},i[7]={week:"목",fromToday:0,skyIcon:"CloudSnow",pop:80,humidityIcon:"Humidity-80",reh:10,tmn:15,tmx:25},i[8]={week:"금",skyIcon:"CloudSnowLightning",pop:90,humidityIcon:"Humidity-90",reh:10,tmn:15,tmx:22},i[9]={week:"토",skyIcon:"Sun",pop:10,humidityIcon:"Humidity-10",reh:10,tmn:12,tmx:22},i[10]={week:"일",skyIcon:"SunBigCloud",pop:20,humidityIcon:"Humidity-10",reh:10,tmn:17,tmx:28},i[11]={week:"월",skyIcon:"Cloud",pop:30,humidityIcon:"Humidity-10",reh:10,tmn:17,tmx:27},i[12]={week:"화",skyIcon:"CloudRain",pop:50,humidityIcon:"Humidity-40",reh:10,tmn:17,tmx:26},i[13]={week:"수",skyIcon:"CloudRainLightning",pop:60,humidityIcon:"Humidity-50",reh:10,tmn:16,tmx:24},i[14]={week:"목",skyIcon:"CloudRainSnow",pop:70,humidityIcon:"Humidity-60",reh:10,tmn:15,tmx:28},i[15]={week:"금",skyIcon:"CloudSnow",pop:80,humidityIcon:"Humidity-70",reh:10,tmn:17,tmx:26},i[16]={week:"토",skyIcon:"CloudSnowLightning",pop:90,humidityIcon:"Humidity-80",reh:10,tmn:13,tmx:24},i[17]={week:"일",skyIcon:"Cloud",pop:10,humidityIcon:"Humidity-90",reh:10,tmn:12,tmx:25},e.dayTable=i,e.dayChart=[{values:i,temp:e.currentWeather.t1h}],t.cities=[],t.cities.push(e)}t.cityIndex=JSON.parse(localStorage.getItem("cityIndex")),null===t.cityIndex&&t.setCityIndex(0)},i.saveCities=function(){if("undefined"==typeof Storage)return!1;var t=this;localStorage.setItem("cities",JSON.stringify(t.cities))},i.updateCities=function(){var t=this,e=t.cities[++t.loadIndex];e&&n.getWeatherInfo(e.address,t.towns).then(function(e){var i=n.convertWeatherData(e);t.updateCity(t.loadIndex,i)}).finally(function(){t.updateCities()})},i.loadTowns=function(){var t=this;t.towns=window.towns},i.setCityIndex=function(t){var e=this;return t>=0&&t<e.cities.length?(e.cityIndex=t,void localStorage.setItem("cityIndex",JSON.stringify(e.cityIndex))):void 0},i}]).factory("WeatherUtil",["$q","$http","Util",function(t,e,n){function i(t,e,n,i){var o="";switch(o=i?"Moon":"Sun",t){case 1:o+="";break;case 2:o+="SmallCloud";break;case 3:o+="BigCloud";break;case 4:o="Cloud"}switch(e){case 0:o+="";break;case 1:o+="Rain";break;case 2:o+="RainSnow";break;case 3:o+="Snow"}return 1===n&&(o+="Lightning"),o}function o(t,e){if(0===t.length)return void 0;for(var n=0;n<t.length;n++)if(t[n].date===e)return t[n];return void 0}function r(t,e){if(!t||!e)return 0;var n=new Date(e.getFullYear(),e.getMonth(),e.getDate());return Math.ceil((t-n)/864e5)}function a(t){var e=t.substr(0,4),n=t.substr(4,2)-1,i=t.substr(6,2),o=new Date(e,n,i);return o.getFullYear()==e&&o.getMonth()==n&&o.getDate()==i?o:void 0}function u(t){var e=["엊그제","그제","어제","오늘","내일","모레","글피"];return t>=-3&&3>=t?e[t+3]:0>t?Math.abs(t)+"일 전":t>0?Math.abs(t)+"일 후":""}function d(t,e,n){if(void 0===e||null===e||void 0===n||null===n||n>e)return"Temp-01";var i=e-n,o=t-n,r=Math.max(1,Math.ceil(o/i*10));return r>9?"Temp-"+r:"Temp-0"+r}function c(t){switch(t){case 0:return"일";case 1:return"월";case 2:return"화";case 3:return"수";case 4:return"목";case 5:return"금";case 6:return"토"}return""}function s(t){switch(t){case"맑음":return"Sun";case"구름조금":return"SunSmallCloud";case"구름많음":return"SunBigCloud";case"흐림":return"Cloud";case"흐리고 한때 비":case"흐리고 비":return"CloudRain";case"구름적고 한때 비":case"구름적고 비":return"SunSmallCloudRain";case"구름많고 한때 비":case"구름많고 비":return"SunBigCloudRain";case"흐리고 한때 눈":case"흐리고 눈":return"CloudSnow";case"구름적고 한때 눈":case"구름적고 눈":return"SunSmallCloudSnow";case"구름많고 한때 눈":case"구름많고 눈":return"SunBigCloudSnow";case"구름적고 비/눈":case"구름적고 눈/비":return"SunSmallCloudRainSnow";case"구름많고 비/눈":case"구름많고 눈/비":return"SunBigCloudRainSnow";case"흐리고 비/눈":case"흐리고 눈/비":return"CloudRainSnow"}return""}function m(t,e){return-1!=t.indexOf("RainSnow")?t:-1!=e.indexOf("RainSnow")?e:-1!=t.indexOf("Rain")&&-1!=e.indexOf("Snow")?t+"Snow":-1!=t.indexOf("Snow")&&-1!=e.indexOf("Rain")?e+"Snow":t}function l(t){var e="Humidity-";return e+=100==t?"90":10*parseInt(t/10)}function p(t){var e="",n=0;return t.forEach(function(t){var i=t.formatted_address.slice(-1);("동"===i||"읍"===i||"면"===i)&&n<t.formatted_address.length&&(e=t.formatted_address,n=t.formatted_address.length)}),0===e.length,e}function h(t){var e={};return t.forEach(function(t){e.lat=t.geometry.location.lat,e.long=t.geometry.location.lng}),e}function y(i){var o=t.defer(),r=n.url+"/town";return r+="/"+i.first,i.second&&(r+="/"+i.second),i.third&&(r+="/"+i.third),e({method:"GET",url:r,timeout:1e4}).success(function(t){o.resolve({data:t})}).error(function(t){t||(t=new Error("Fail to get weatherInfo")),o.reject(t)}),o.promise}function f(n){var i=t.defer(),o="https://apis.daum.net/local/geo/addr2coord?apikey=6d0116e2c49361cb75eaf12f665e6360&q="+encodeURIComponent(n)+"&output=json";return e({method:"GET",url:o,timeout:3e3}).success(function(t){var e=t.channel.item[0].lat,n=t.channel.item[0].lng,o={lat:e,"long":n};i.resolve(o)}).error(function(t){i.reject(t)}),i.promise}function g(n){var i=t.defer(),o="https://maps.googleapis.com/maps/api/geocode/json?address="+n;return e({method:"GET",url:o,timeout:3e3}).success(function(t){if("OK"===t.status){var e=h(t.results);i.resolve(e)}else i.reject(new Error(t.status))}).error(function(t){i.reject(t)}),i.promise}function I(n,i){var o=t.defer(),r="https://apis.daum.net/local/geo/coord2addr?apikey=6d0116e2c49361cb75eaf12f665e6360&longitude="+i+"&latitude="+n+"&inputCoordSystem=WGS84&output=json";return e({method:"GET",url:r,timeout:3e3}).success(function(t){if(t.fullName){var e=t.fullName;e="대한민국 "+e,o.resolve(e)}else o.reject(new Error("Fail to get address name"))}).error(function(t){o.reject(t)}),o.promise}function S(n,i){var o=t.defer(),r="https://maps.googleapis.com/maps/api/geocode/json?latlng="+n+","+i+"&sensor=true&language=ko";return e({method:"GET",url:r,timeout:3e3}).success(function(t){if("OK"===t.status){var e=p(t.results);e&&0!==e.length||o.reject(new Error("Fail to find dong address from "+t.results[0].formatted_address)),o.resolve(e)}else o.reject(new Error(t.status))}).error(function(t){o.reject(t)}),o.promise}var v={};return v.parseCurrentTownWeather=function(t){var e,n,o={};return t?(e=parseInt(t.time.substr(0,2)),n=7>e||e>18,o=t,o.time=e,o.skyIcon=i(t.sky,t.pty,t.lgt,n),o):o},v.parseShortTownWeather=function(t,e,n,c){var s=[];if(!t||!Array.isArray(t))return{timeTable:[],timeChart:[]};t.every(function(e,m){var l,p=parseInt(e.time.slice(0,-2)),h=r(a(e.date),n),y="";(0===m||t[m-1].date!==e.date)&&(y=u(h));var f=7>p||p>18,g=o(c,e.date);return g||(g={date:e.date,taMax:100,taMin:-49}),l=e,l.skyIcon=i(e.sky,e.pty,e.lgt,f),l.tempIcon=d(e.t3h,g.taMax,g.taMin),l.day=y,l.time=p,l.timeStr=p+"시",s.push(l),!0});var m=s.slice(8),l=[{name:"yesterday",values:s.slice(0,s.length-8).map(function(t){return{name:"yesterday",value:t}})},{name:"today",values:s.slice(8).map(function(t){return{name:"today",value:t}})}];return{timeTable:m,timeChart:l}},v.parseMidTownWeather=function(t,e){var n=[];return t&&t.hasOwnProperty("dailyData")&&Array.isArray(t.dailyData)?(t.dailyData.forEach(function(t){var i;i=t;var o=r(a(i.date),e);i.fromToday=o,i.fromTodayStr=u(o),i.week=c(a(i.date).getDay());var d=s(t.wfAm),p=s(t.wfPm);i.skyIcon=m(d,p),i.tmx=t.taMax,i.tmn=t.taMin,i.humidityIcon=void 0!==i.reh?l(i.reh):"Humidity-00",n.push(i)}),n):n},v.convertTimeString=function(t){return t.getMonth()+1+"월 "+t.getDate()+"일("+c(t.getDay())+")  "+(t.getHours()<10?"0":"")+t.getHours()+":"+(t.getMinutes()<10?"0":"")+t.getMinutes()},v.convertAddressArray=function(t){var e=[];return t&&t.split&&(e=t.split(" ")),e},v._getShortSiDoName=function(t){for(var e=["특별시","광역시","특별자치시","특별자치도"],n=0;n<e.length;n++)if(t.slice(-1*e[n].length)===e[n])return n===e.length-1?t.replace(e[n],"도"):t.replace(e[n],"시");return t},v.getShortenAddress=function(t){var e=this,n=e.convertAddressArray(t);return!n||n.length<2?"":5===n.length?e._getShortSiDoName(n[2])+","+n[4]:4===n.length?"도"===n[1].slice(-1)?e._getShortSiDoName(n[2])+","+n[3]:e._getShortSiDoName(n[1])+","+n[3]:3===n.length?e._getShortSiDoName(n[1])+","+n[2]:2===n.length?e._getShortSiDoName(n[1]):""},v.getTownFromFullAddress=function(t){var e={first:"",second:"",third:""};if(!Array.isArray(t)||0===t.length)return e;if(5===t.length)e.first=t[1],e.second=t[2]+t[3],e.third=t[4];else if(4===t.length)e.first=t[1],"구"===t[3].slice(-1)?e.second=t[2]+t[3]:(e.second=t[2],e.third=t[3]);else if(3===t.length)"읍"===t[2].slice(-1)||"면"===t[2].slice(-1)||"동"===t[2].slice(-1)?(e.first=t[1],e.second=t[1],e.third=t[2]):(e.first=t[1],e.second=t[2]);else if(2===t.length)e.first=t[1];else{new Error("Fail to parse address array="+t.toString())}return e},v.getAddressToGeolocation=function(e){var n=t.defer();return f(e).then(function(t){n.resolve(t)},function(t){g(e).then(function(t){n.resolve(t)},function(t){n.reject(t)})}),n.promise},v.getAddressFromGeolocation=function(e,n){var i=t.defer();return I(e,n).then(function(t){i.resolve(t)},function(t){S(e,n).then(function(t){i.resolve(t)},function(t){i.reject(t)})}),i.promise},v.getCurrentPosition=function(){var e=t.defer();if(ionic.Platform.isAndroid()&&window.cordova){var n=cordova.require("cordova/modulemapper").getOriginalSymbol(window,"navigator.geolocation");n.getCurrentPosition(function(t){e.resolve(t.coords)},function(t){e.reject()},{timeout:5e3})}else navigator.geolocation.getCurrentPosition(function(t){e.resolve(t.coords)},function(t){e.reject()},{timeout:3e3});return e.promise},v.getWeatherInfo=function(e,n){var i=this,o=i.convertAddressArray(e),r=i.getTownFromFullAddress(o),a=n.filter(function(t){return!(t.first!==r.first||t.second!==r.second||t.third!==r.third)})[0];if(void 0===a){var u=t.defer();return u.reject("address is empty"),u.promise}var d=[];return d.push(y(a)),t.all(d)},v.convertWeatherData=function(t){var e=this,n={},i=new Date,o={};t.forEach(function(t){t.hasOwnProperty("data")&&(o=t.data)});var r=e.parseCurrentTownWeather(o.current),a=e.parseShortTownWeather(o.short,r,i,o.midData.dailyData),u=e.parseMidTownWeather(o.midData,i);return n.currentWeather=r,n.timeTable=a.timeTable,n.timeChart=a.timeChart,n.dayTable=u,n.dayChart=[{values:u,temp:r.t1h}],n},v.getWeatherEmoji=function(t){return-1!=t.indexOf("Lightning")?"⛈":-1!=t.indexOf("RainSnow")?"☔☃":-1!=t.indexOf("Rain")?"☔":-1!=t.indexOf("Snow")?"☃":-1!=t.indexOf("Cloud")?-1!=t.indexOf("Sun")||-1!=t.indexOf("Moon")?"⛅":"☁":-1!=t.indexOf("Sun")||-1!=t.indexOf("Moon")?"🌞":""},v}]).factory("Util",["$window","$cordovaGoogleAnalytics",function(t,e){var n={},i=!1;return n.isDebug=function(){return i},n.ga={startTrackerWithId:function(n){return"undefined"!=typeof t.analytics?e.startTrackerWithId(n):void 0},setUserId:function(n){return"undefined"!=typeof t.analytics?e.setUserId(n):void 0},debugMode:function(){return"undefined"!=typeof t.analytics?e.debugMode():void 0},trackView:function(n){return"undefined"!=typeof t.analytics?e.trackView(n):void 0},addCustomDimension:function(n,i){return"undefined"!=typeof t.analytics?e.addCustomDimension(n,i):void 0},trackEvent:function(n,i,o,r){return"undefined"!=typeof t.analytics?e.trackEvent(n,i,o,r):void 0},trackException:function(n,i){return"undefined"!=typeof t.analytics?e.trackException(n,i):void 0},trackTiming:function(n,i,o,r){return"undefined"!=typeof t.analytics?e.trackTiming(n,i,o,r):void 0},addTransaction:function(n,i,o,r,a,u){return"undefined"!=typeof t.analytics?e.addTransaction(n,i,o,r,a,u):void 0},addTransactionItem:function(n,i,o,r,a,u,d){return"undefined"!=typeof t.analytics?e.addTransactionItem(n,i,o,r,a,u,d):void 0}},n.imgPath="img/weatherIcon",n.guideVersion=1,n.admobIOSBannerAdUnit="ca-app-pub-3300619349648096/7636193363",n.admobIOSInterstitialAdUnit="ca-app-pub-3300619349648096/3066392962",n.admobAndroidBannerAdUnit="ca-app-pub-3300619349648096/9569086167",n.admobAndroidInterstitialAdUnit="ca-app-pub-3300619349648096/2045819361",n.googleSenderId="362303467798",n.url=i?"http://tw-wzdfac.rhcloud.com/v000705":"http://todayweather.wizardfactory.net/v000705",n}]);